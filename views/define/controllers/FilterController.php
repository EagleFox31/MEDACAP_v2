<?php
use MongoDB\BSON\ObjectId;
/**
 * Contr√¥leur de gestion des filtres pour les dashboards
 * Impl√©mente le syst√®me de filtrage avanc√© avec les d√©pendances hi√©rarchiques
 */
class FilterController {
    private $academy;
    
    /**
     * Constructeur
     * 
     * @param MongoDB\Database $academy Instance de la base de donn√©es MongoDB
     */
    public function __construct($academy = null) {
        $this->academy = $academy;
    }
    
    /**  S√©lectionne :
     *   ‚Äì tous les Techniciens
     *   ‚Äì les Managers ayant test = true
     */
    private function getTechOrTestManagerClause(): array
    {
        return [
            '$or' => [
                ['profile' => 'Technicien'],
                ['profile' => 'Manager', 'test' => true],
            ],
        ];
    }

    /**
     * R√©cup√®re et traite les filtres depuis les param√®tres GET
     * 
     * @return array Tableau associatif contenant les filtres appliqu√©s
     */
    public function getFilters() {
        // R√©cup√©ration des valeurs de filtre depuis l'URL
        $filters = [
            'subsidiary' => $_GET['subsidiary'] ?? $_SESSION['subsidiary'] ?? 'all',
            'agency' => $_GET['agency'] ?? 'all',
            'managerId' => $_GET['managerId'] ?? 'all',
            'level' => $_GET['level'] ?? 'all',
            'brand' => $_GET['brand'] ?? 'all',
            'technicianId' => $_GET['technicianId'] ?? 'all'
        ];
        
        // Logique suppl√©mentaire pour le filtrage selon le profil utilisateur
        if ($_SESSION['profile'] === 'Manager') {
            // Un manager ne peut voir que ses propres techniciens
            $filters['managerId'] = $_SESSION['id'];
        } else if (!in_array($_SESSION['profile'], ['Super Admin', 'Group Director'])) {
            // Ces profils sont limit√©s √† leur filiale (sauf Super Admin et Group Director)
            $filters['subsidiary'] = $_SESSION['subsidiary'];
        }
        
        // Si un technicien est s√©lectionn√©, pr√©-remplir tous les autres filtres
        if ($filters['technicianId'] !== 'all') {
            $this->hydrateFiltersFromTechnician($filters);
        }
        // Sinon, si une marque est s√©lectionn√©e, ajuster les niveaux et techniciens
        else if ($filters['brand'] !== 'all') {
            $this->adjustFiltersByBrand($filters);
        }
        // Sinon, si un niveau est s√©lectionn√©, ajuster les marques et techniciens
        else if ($filters['level'] !== 'all') {
            $this->adjustFiltersByLevel($filters);
        }
        
        return $filters;
    }
    
    /**
     * Remplit tous les filtres en fonction d'un technicien s√©lectionn√©
     * 
     * @param array &$filters Tableau de filtres √† modifier
     */
    private function hydrateFiltersFromTechnician(&$filters) {
        if (!$this->academy || $filters['technicianId'] === 'all') {
            return;
        }
        
        try {
            // Convertir l'ID du technicien en ObjectId
            $technicianObjId = $filters['technicianId']; // Use string ID directly
            
            // R√©cup√©rer les donn√©es du technicien
            $technician = $this->academy->users->findOne(
                ['_id' => $technicianObjId],
                [
                    'projection' => [
                        'subsidiary' => 1,
                        'agency' => 1,
                        'manager' => 1,
                        'level' => 1,
                        'brandJunior' => 1,
                        'brandSenior' => 1,
                        'brandExpert' => 1
                    ]
                ]
            );
            
            if ($technician) {
                // Mettre √† jour les filtres avec les donn√©es du technicien
                $filters['subsidiary'] = $technician['subsidiary'] ?? $filters['subsidiary'];
                $filters['agency'] = $technician['agency'] ?? $filters['agency'];
                
                // R√©cup√©rer le manager du technicien si disponible
                if (isset($technician['manager']) && !empty($technician['manager'])) {
                    $filters['managerId'] = (string)$technician['manager'];
                }
                
                // D√©terminer le niveau du technicien
                $filters['level'] = $technician['level'] ?? $filters['level'];
                
                // D√©terminer les marques associ√©es au technicien en fonction de son niveau
                // Pour l'instant on prend juste la premi√®re marque pour simplifier
                $brandField = 'brandJunior';
                if ($filters['level'] === 'Expert' && isset($technician['brandExpert'])) {
                    $brandField = 'brandExpert';
                } else if ($filters['level'] === 'Senior' && isset($technician['brandSenior'])) {
                    $brandField = 'brandSenior';
                }
                
                if (isset($technician[$brandField]) && !empty($technician[$brandField])) {
                    $filters['brand'] = $technician[$brandField];
                }
            }
        } catch (Exception $e) {
            error_log("Erreur lors de l'hydratation des filtres depuis le technicien: " . $e->getMessage());
        }
    }
    
    /**
     * Ajuste les filtres lorsque l‚Äôutilisateur choisit une marque.
     */
    private function adjustFiltersByBrand(array &$filters): void
    {
        if (!$this->academy || $filters['brand'] === 'all') {
            return; // rien √† faire
        }

        try {
            /* -----------------------------------------------------------------
            * 1) Requ√™te principale : Technicien ùêéùêî Manager(test=true)
            *    + actifs
            *    + poss√©dant la marque demand√©e (dans l‚Äôun des 3 champs)
            * ----------------------------------------------------------------- */
            $query = array_merge(
                $this->getTechOrTestManagerClause(),      // profil Technicien √©largi
                [
                    'active' => true,
                    '$or'    => [
                        ['brandJunior' => $filters['brand']],
                        ['brandSenior' => $filters['brand']],
                        ['brandExpert' => $filters['brand']],
                    ],
                ],
            );

            /* -----------------------------------------------------------------
            * 2) Filtres compl√©mentaires (filiale, agence, manager)
            * ----------------------------------------------------------------- */
            if ($filters['subsidiary'] !== 'all') {
                $query['subsidiary'] = $filters['subsidiary'];
            }
            if ($filters['agency'] !== 'all') {
                $query['agency'] = $filters['agency'];
            }
            if ($filters['managerId'] !== 'all') {
                $query['manager'] = $filters['managerId']; // id d√©j√† sous forme de string
            }

            /* -----------------------------------------------------------------
            * 3) Ex√©cution et d√©termination du niveau max pr√©sent
            * ----------------------------------------------------------------- */
            $technicians = $this->academy->users->find(
                $query,
                ['projection' => ['_id' => 1, 'level' => 1]]
            )->toArray();

            $maxLevel             = $this->determineMaxLevel($technicians);
            $filters['maxLevel']  = $maxLevel;

            /* -----------------------------------------------------------------
            * 4) Validation d‚Äôun √©ventuel filtre 'level' d√©j√† actif
            * ----------------------------------------------------------------- */
            if ($filters['level'] !== 'all') {
                $validLevels = $this->getLevelsToInclude($maxLevel);
                if (!in_array($filters['level'], $validLevels, true)) {
                    $filters['level'] = 'all'; // reset si incoh√©rent
                }
            }

        } catch (Exception $e) {
            error_log("Erreur ajustement filtre marque : " . $e->getMessage());
        }
    }

        
    /**
     * Ajuste les filtres lorsque l‚Äôutilisateur choisit un niveau.
     *
     * @param array $filters  R√©f√©rence vers le tableau des filtres courants
     */
    private function adjustFiltersByLevel(array &$filters): void
    {
        if (!$this->academy || $filters['level'] === 'all') {
            return;                                // aucun niveau choisi ‚Üí rien √† faire
        }

        try {
            /* -----------------------------------------------------------------
            * 1) Clause de base : Technicien (+ Manager test=true) actifs
            * ----------------------------------------------------------------- */
            $query = array_merge(
                $this->getTechOrTestManagerClause(),   // profil √©largi
                ['active' => true]
            );

            /* -----------------------------------------------------------------
            * 2) Filtre ¬´ level ¬ª hi√©rarchique
            *    Junior  ‚Üí Junior + Senior + Expert
            *    Senior  ‚Üí Senior + Expert
            *    Expert  ‚Üí Expert
            * ----------------------------------------------------------------- */
            switch ($filters['level']) {
                case 'Junior':
                    $query['level'] = ['$in' => ['Junior', 'Senior', 'Expert']];
                    break;
                case 'Senior':
                    $query['level'] = ['$in' => ['Senior', 'Expert']];
                    break;
                case 'Expert':
                default:
                    $query['level'] = 'Expert';
                    break;
            }

            /* -----------------------------------------------------------------
            * 3) Filtres compl√©mentaires (filiale, agence, manager)
            * ----------------------------------------------------------------- */
            if ($filters['subsidiary'] !== 'all') {
                $query['subsidiary'] = $filters['subsidiary'];
            }
            if ($filters['agency'] !== 'all') {
                $query['agency'] = $filters['agency'];
            }
            if ($filters['managerId'] !== 'all') {
                $query['manager'] = $filters['managerId'];
            }

            /* -----------------------------------------------------------------
            * 4) Recherche des techniciens et calcul des marques communes
            * ----------------------------------------------------------------- */
            $technicians = $this->academy->users->find(
                $query,
                ['projection' => [
                    '_id'         => 1,
                    'brandJunior' => 1,
                    'brandSenior' => 1,
                    'brandExpert' => 1,
                ]]
            )->toArray();

            $commonBrands               = $this->findCommonBrands($technicians);
            $filters['availableBrands'] = $commonBrands;

            /* Si la marque d√©j√† s√©lectionn√©e n‚Äôappartient pas au nouvel ensemble,
            on la r√©initialise. */
            if ($filters['brand'] !== 'all' && !in_array($filters['brand'], $commonBrands, true)) {
                $filters['brand'] = 'all';
            }

        } catch (Exception $e) {
            error_log("Erreur ajustement filtre niveau : " . $e->getMessage());
        }
    }

    
    /**
     * D√©termine le niveau maximum parmi une liste de techniciens
     * 
     * @param array $technicians Liste des techniciens
     * @return string Niveau maximum (Junior, Senior ou Expert)
     */
    private function determineMaxLevel($technicians) {
        $levelMapping = ['Junior' => 1, 'Senior' => 2, 'Expert' => 3];
        $maxLevelValue = 0;
        $maxLevel = 'Junior';
        
        foreach ($technicians as $tech) {
            $levelValue = $levelMapping[$tech['level'] ?? 'Junior'] ?? 0;
            if ($levelValue > $maxLevelValue) {
                $maxLevelValue = $levelValue;
                $maxLevel = $tech['level'];
            }
        }
        
        return $maxLevel;
    }

    private function normalizeBrands($raw): array
    {
        // 1. BSONArray ‚Üí array PHP
        if ($raw instanceof \MongoDB\Model\BSONArray) {
            $raw = $raw->getArrayCopy();
        }

        // 2. Pas un tableau ?  ‚Üí []
        if (!is_array($raw)) {
            return [];
        }

        // 3. trim + suppression des vides + unicit√©
        return array_values(
            array_unique(
                array_filter(
                        array_map('trim', $raw),
                        function ($v) {
                            return $v !== '';
                        }
                    )

            )
        );
    }
    
    /**
     * Trouve les marques communes √† tous les techniciens de la liste
     * 
     * @param array $technicians Liste des techniciens
     * @return array Liste des marques communes
     */
    private function findCommonBrands(array $technicians): array
    {
        $sets = [];

        foreach ($technicians as $tech) {
            $merged = array_merge(
                $this->normalizeBrands($tech['brandJunior'] ?? []),
                $this->normalizeBrands($tech['brandSenior'] ?? []),
                $this->normalizeBrands($tech['brandExpert'] ?? [])
            );
            
            // Remove duplicates after merge to avoid repeated values in
            // intersection result
            $sets[] = array_values(array_unique($merged, SORT_STRING));
        }

        // Aucun technicien ‚Üí aucune marque
        if (empty($sets)) {
            return [];
        }

        // Intersection progressive
        $common = array_shift($sets);
        foreach ($sets as $set) {
            $common = array_intersect($common, $set);
            // Petit court-circuit : plus rien en commun ‚Üí on peut sortir
            if (empty($common)) {
                return [];
            }
        }

        // Clean duplicate values and reindex
        return array_values(array_unique($common, SORT_STRING));
    }
    
    /**
     * Retourne les niveaux √† inclure en fonction du niveau maximum
     * 
     * @param string $maxLevel Niveau maximum (Junior, Senior ou Expert)
     * @return array Liste des niveaux √† inclure
     */
    public function getLevelsToInclude($maxLevel) {
        switch ($maxLevel) {
            case 'Expert':
                return ['Junior', 'Senior', 'Expert'];
            case 'Senior':
                return ['Junior', 'Senior'];
            case 'Junior':
            default:
                return ['Junior'];
        }
    }
    
    /**
     * R√©cup√®re les filiales disponibles
     * 
     * @return array Liste des filiales disponibles
     */
    public function getSubsidiaries() {
        $subsidiaries = [];
        
        if ($this->academy) {
            try {
                // R√©cup√©rer toutes les filiales distinctes depuis la collection des utilisateurs
                $cursor = $this->academy->users->distinct('subsidiary', ['active' => true]);
                $subsidiaries = $cursor;
            } catch (Exception $e) {
                error_log("Erreur lors de la r√©cup√©ration des filiales: " . $e->getMessage());
            }
        }
        
        return $subsidiaries;
    }
    
    /**
     * R√©cup√®re les agences d'une filiale
     * 
     * @param string $subsidiary Nom de la filiale
     * @return array Liste des agences de la filiale
     */
    public function getAgencies($subsidiary) {
        $agencies = [];
        
        if ($this->academy && $subsidiary !== 'all') {
            try {
                error_log('[FilterController] Fetching agencies for ' . $subsidiary);
                // Requ√™te insensible √† la casse pour √©viter les probl√®mes de
                // variations d'√©criture dans la base
                $query = [
                    'subsidiary' => new \MongoDB\BSON\Regex('^' . preg_quote(trim($subsidiary)) . '$', 'i'),
                    'active'     => true
                ];


                // R√©cup√©rer toutes les agences distinctes pour la filiale sp√©cifi√©e
                $agencies = $this->academy->users->distinct('agency', $query);

                // Nettoyer et d√©dupliquer les valeurs r√©cup√©r√©es
                $agencies = array_values(array_unique(array_map('trim', $agencies)));
                error_log('[FilterController] Agencies found: ' . json_encode($agencies));
            } catch (Exception $e) {
                error_log("Erreur lors de la r√©cup√©ration des agences: " . $e->getMessage());
            }
        }

        
        // Fallback: if no agencies retrieved from DB, use static configuration
        if (empty($agencies) && $subsidiary !== 'all') {
            $agencyMap = include __DIR__ . '/../components/agencyData.php';
            if (isset($agencyMap[$subsidiary])) {
                $agencies = $agencyMap[$subsidiary];
                error_log('[FilterController] Agencies from config: ' . json_encode($agencies));
            } else {
                error_log('[FilterController] No agencies found for ' . $subsidiary . ' in config');
            }
        }

        
        return $agencies;
    }
    
    /**
     * R√©cup√®re les managers d'une filiale/agence
     * 
     * @param string $subsidiary Nom de la filiale
     * @param string $agency Nom de l'agence (optionnel)
     * @return array Liste des managers avec leur ID et nom
     */
    public function getManagers($subsidiary, $agency = 'all') {
        $managers = [];
        
        if ($this->academy && $subsidiary !== 'all') {
            try {
                // Construire la requ√™te
                $query = [
                    'subsidiary' => $subsidiary,
                    'profile' => 'Manager',
                    'active' => true
                ];
                
                // Ajouter le filtre d'agence si sp√©cifi√©
                if ($agency !== 'all') {
                    $query['agency'] = $agency;
                }
                
                // Ex√©cuter la requ√™te
                $cursor = $this->academy->users->find($query, [
                    'projection' => [
                        '_id' => 1,
                        'firstName' => 1,
                        'lastName' => 1
                    ]
                ]);
                
                // Traiter les r√©sultats
                foreach ($cursor as $manager) {
                    $managers[(string)$manager['_id']] = $manager['firstName'] . ' ' . $manager['lastName'];
                }
            } catch (Exception $e) {
                error_log("Erreur lors de la r√©cup√©ration des managers: " . $e->getMessage());
            }
        }
        
        return $managers;
    }
    
    /**
     * R√©cup√®re les marques disponibles, filtr√© par les autres crit√®res si n√©cessaire
     * 
     * @param array $filters Filtres actuels
     * @return array Liste des marques
     */
    public function getBrands($filters = []) {
        // Si des marques filtr√©es sont d√©j√† disponibles, les utiliser
        if (isset($filters['availableBrands']) && !empty($filters['availableBrands'])) {
            return $filters['availableBrands'];
        }
        
        $brands = [];
        
        if ($this->academy) {
            try {
                $query = ['active' => true];
                
                // Ajouter des filtres suppl√©mentaires si n√©cessaire
                if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                    $query['subsidiary'] = $filters['subsidiary'];
                }
                if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                    $query['agency'] = $filters['agency'];
                }
                if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                    $query['manager'] = $filters['managerId']; // Use string ID directly
                }
                
                // R√©cup√©rer toutes les marques distinctes depuis diff√©rentes sources
                $brandJunior = $this->academy->users->distinct('brandJunior', $query);
                $brandSenior = $this->academy->users->distinct('brandSenior', $query);
                $brandExpert = $this->academy->users->distinct('brandExpert', $query);
                
               // Combiner puis d√©dupliquer en ignorant la casse et les espaces
                $allBrands = array_merge($brandJunior, $brandSenior, $brandExpert);
                $normalized = [];
                foreach ($allBrands as $brandName) {
                    $trimmed = trim((string)$brandName);
                    if ($trimmed === '') {
                        continue;
                    }
                    $key = mb_strtolower($trimmed);
                    if (!isset($normalized[$key])) {
                        $normalized[$key] = $trimmed;
                    }
                }

                $brands = array_values($normalized);

                // Trier les marques alphab√©tiquement (sans tenir compte de la casse)
                sort($brands, SORT_FLAG_CASE | SORT_STRING);
            } catch (Exception $e) {
                error_log("Erreur lors de la r√©cup√©ration des marques: " . $e->getMessage());
            }
        }
        
        return $brands;
    }
    
    /**
     * R√©cup√®re les techniciens disponibles selon les filtres actuels
     * 
     * @param array $filters Filtres actuels
     * @return array Liste des techniciens avec leur ID et nom
     */
    public function getTechnicians($filters = []) {
        $technicians = [];
        
        if ($this->academy) {
            try {
                // Construire la requ√™te de base
                $query = array_merge(
                $this->getTechOrTestManagerClause(),
                ['active'=>true]
            );

                
                // Ajouter des filtres suppl√©mentaires
                if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                    $query['subsidiary'] = $filters['subsidiary'];
                }
                if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                    $query['agency'] = $filters['agency'];
                }
                if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                    $query['manager'] = $filters['managerId']; // Use string ID directly
                }
                
                // Filtre par niveau
                if (isset($filters['level']) && $filters['level'] !== 'all') {
                    // Logique pour inclure les niveaux correspondants
                    if ($filters['level'] === 'Junior') {
                        $query['level'] = ['$in' => ['Junior', 'Senior', 'Expert']];
                    } else if ($filters['level'] === 'Senior') {
                        $query['level'] = ['$in' => ['Senior', 'Expert']];
                    } else if ($filters['level'] === 'Expert') {
                        $query['level'] = 'Expert';
                    }
                }
                
                // Filtre par marque
                if (isset($filters['brand']) && $filters['brand'] !== 'all') {
                    $query['$or'] = [
                        ['brandJunior' => $filters['brand']],
                        ['brandSenior' => $filters['brand']],
                        ['brandExpert' => $filters['brand']]
                    ];
                }
                
                // Ex√©cuter la requ√™te
                $cursor = $this->academy->users->find($query, [
                    'projection' => [
                        '_id' => 1,
                        'firstName' => 1,
                        'lastName' => 1
                    ]
                ]);
                
                // Traiter les r√©sultats
                foreach ($cursor as $technician) {
                    $technicians[(string)$technician['_id']] = $technician['firstName'] . ' ' . $technician['lastName'];
                }
            } catch (Exception $e) {
                error_log("Erreur lors de la r√©cup√©ration des techniciens: " . $e->getMessage());
            }
        }
        
        return $technicians;
    }
    
    /**
     * D√©termine si l'utilisateur actuel est un Super Admin ou Group Director
     * 
     * @return bool True si l'utilisateur peut voir toutes les filiales
     */
    public function canSelectSubsidiary() {
        return in_array($_SESSION['profile'] ?? '', ['Super Admin', 'Group Director']);
    }
    
    /**
     * R√©cup√®re les statistiques globales des niveaux pour l'UI adaptative
     * 
     * @param array $filters Filtres actuels √† appliquer
     * @return array Statistiques des niveaux (juniorCount, seniorCount, expertCount)
     */
    public function getLevelStats($filters = []) {
        $stats = [
            'juniorCount' => 0,
            'seniorCount' => 0,
            'expertCount' => 0
        ];
        
        if ($this->academy) {
            try {
                // Construire la requ√™te de base
                $query = array_merge(
                    $this->getTechOrTestManagerClause(),   // ‚Üê remplace $this->getTechOrTestManagerClause()
                    ['active' => true]
                );
                
                // Ajouter des filtres suppl√©mentaires
                if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                    $query['subsidiary'] = $filters['subsidiary'];
                }
                if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                    $query['agency'] = $filters['agency'];
                }
                if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                    $query['manager'] = $filters['managerId']; // Use string ID directly
                }
                if (isset($filters['brand']) && $filters['brand'] !== 'all') {
                    $query['$or'] = [
                        ['brandJunior' => $filters['brand']],
                        ['brandSenior' => $filters['brand']],
                        ['brandExpert' => $filters['brand']]
                    ];
                }
                
                // Compter par niveau
                $stats['juniorCount'] = $this->academy->users->count(array_merge($query, ['level' => 'Junior']));
                $stats['seniorCount'] = $this->academy->users->count(array_merge($query, ['level' => 'Senior']));
                $stats['expertCount'] = $this->academy->users->count(array_merge($query, ['level' => 'Expert']));
            } catch (Exception $e) {
                error_log("Erreur lors du calcul des statistiques de niveau: " . $e->getMessage());
            }
        }
        
        return $stats;
    }
    
    /**
     * R√©cup√®re les statistiques globales pour le tableau de bord
     *
     * @param array $filters Filtres actuels √† appliquer
     * @return array Statistiques globales
     */
    public function getGlobalStats($filters = []) {
        // Initialisation des statistiques de base
        $stats = [
            'totalTechnicians' => 0,
            'juniorCount' => 0,
            'seniorCount' => 0,
            'expertCount' => 0,
            'measuredCount' => 0,
            'withTrainingCount' => 0,
            'validatedTrainingCount' => 0
        ];
        
        if ($this->academy) {
            try {
                // Obtenir les statistiques de niveau
                $levelStats = $this->getLevelStats($filters);
                $stats['juniorCount'] = $levelStats['juniorCount'];
                $stats['seniorCount'] = $levelStats['seniorCount'];
                $stats['expertCount'] = $levelStats['expertCount'];
                $stats['totalTechnicians'] = $levelStats['juniorCount'] + $levelStats['seniorCount'] + $levelStats['expertCount'];
                
                // Construire la requ√™te de base pour les comptages
                $query = array_merge(
                    $this->getTechOrTestManagerClause(),
                    ['active' => true]
                );

                
                // Ajouter des filtres suppl√©mentaires
                if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                    $query['subsidiary'] = $filters['subsidiary'];
                }
                if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                    $query['agency'] = $filters['agency'];
                }
                if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                    $query['manager'] = $filters['managerId']; // Use string ID directly
                }
                if (isset($filters['level']) && $filters['level'] !== 'all') {
                    if ($filters['level'] === 'Junior') {
                        $query['level'] = ['$in' => ['Junior', 'Senior', 'Expert']];
                    } else if ($filters['level'] === 'Senior') {
                        $query['level'] = ['$in' => ['Senior', 'Expert']];
                    } else if ($filters['level'] === 'Expert') {
                        $query['level'] = 'Expert';
                    }
                }
                if (isset($filters['brand']) && $filters['brand'] !== 'all') {
                    $query['$or'] = [
                        ['brandJunior' => $filters['brand']],
                        ['brandSenior' => $filters['brand']],
                        ['brandExpert' => $filters['brand']]
                    ];
                }
                
                // Compter les techniciens mesur√©s (poss√©dant des r√©sultats d'√©valuation)
                $measuredQuery = array_merge($query, ['evaluationResults' => ['$exists' => true, '$ne' => []]]);
                $stats['measuredCount'] = $this->academy->users->count($measuredQuery);
                
                // Compter les techniciens avec PIF (ayant des formations recommand√©es)
                $withTrainingQuery = array_merge($query, ['recommendedTrainings' => ['$exists' => true, '$ne' => []]]);
                $stats['withTrainingCount'] = $this->academy->users->count($withTrainingQuery);
                
                // Compter les formations valid√©es
                $validatedTrainingCount = 0;
                $cursor = $this->academy->users->find($withTrainingQuery, [
                    'projection' => ['recommendedTrainings' => 1]
                ]);
                
                foreach ($cursor as $user) {
                    if (isset($user['recommendedTrainings']) && is_array($user['recommendedTrainings'])) {
                        foreach ($user['recommendedTrainings'] as $training) {
                            if (isset($training['status']) && $training['status'] === 'validated') {
                                $validatedTrainingCount++;
                            }
                        }
                    }
                }
                $stats['validatedTrainingCount'] = $validatedTrainingCount;
                
            } catch (Exception $e) {
                error_log("Erreur lors du calcul des statistiques globales: " . $e->getMessage());
            }
        }
        
        return $stats;
    }
    
    /**
     * R√©cup√®re les statistiques par marque
     *
     * @param array $filters Filtres actuels √† appliquer
     * @return array Statistiques par marque
     */
    public function getBrandStats($filters = []) {
        $stats = [];
        
        if ($this->academy) {
            try {
                // R√©cup√©rer les marques disponibles
                $brands = $this->getBrands($filters);
                
                // Initialiser les statistiques pour chaque marque
                foreach ($brands as $brand) {
                    $stats[$brand] = [
                        'technicianCount' => 0,
                        'averageScore' => 0,
                        'recommendedTrainings' => 0,
                        'validatedTrainings' => 0
                    ];
                }
                
                // Construire la requ√™te de base pour les techniciens
                $baseQuery = array_merge(
                    $this->getTechOrTestManagerClause(),
                    ['active'=>true]
                );
                
                // Ajouter les filtres suppl√©mentaires
                if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                    $baseQuery['subsidiary'] = $filters['subsidiary'];
                }
                if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                    $baseQuery['agency'] = $filters['agency'];
                }
                if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                    $baseQuery['manager'] = $filters['managerId'];
                }
                if (isset($filters['level']) && $filters['level'] !== 'all') {
                    if ($filters['level'] === 'Junior') {
                        $baseQuery['level'] = ['$in' => ['Junior', 'Senior', 'Expert']];
                    } else if ($filters['level'] === 'Senior') {
                        $baseQuery['level'] = ['$in' => ['Senior', 'Expert']];
                    } else if ($filters['level'] === 'Expert') {
                        $baseQuery['level'] = 'Expert';
                    }
                }
                
                // Calculer les statistiques pour chaque marque
                foreach ($brands as $brand) {
                    // Requ√™te pour les techniciens de cette marque
                    $query = array_merge($baseQuery, [
                        '$or' => [
                            ['brandJunior' => $brand],
                            ['brandSenior' => $brand],
                            ['brandExpert' => $brand]
                        ]
                    ]);
                    
                    // Compter les techniciens pour cette marque
                    $stats[$brand]['technicianCount'] = $this->academy->users->count($query);
                    
                    // Calculer le score moyen pour cette marque
                    $scoreQuery = array_merge($query, ['evaluationResults' => ['$exists' => true, '$ne' => []]]);
                    $technicians = $this->academy->users->find($scoreQuery, [
                        'projection' => ['evaluationResults' => 1]
                    ])->toArray();
                    
                    $totalScore = 0;
                    $count = 0;
                    
                    foreach ($technicians as $tech) {
                        if (isset($tech['evaluationResults']) && is_array($tech['evaluationResults'])) {
                            foreach ($tech['evaluationResults'] as $eval) {
                                if (isset($eval['brand']) && $eval['brand'] === $brand && isset($eval['score'])) {
                                    $totalScore += $eval['score'];
                                    $count++;
                                }
                            }
                        }
                    }
                    
                    $stats[$brand]['averageScore'] = ($count > 0) ? round($totalScore / $count) : 0;
                    
                    // Calculer les statistiques de formation pour cette marque
                    $trainingQuery = array_merge($query, ['recommendedTrainings' => ['$exists' => true, '$ne' => []]]);
                    $technicians = $this->academy->users->find($trainingQuery, [
                        'projection' => ['recommendedTrainings' => 1]
                    ])->toArray();
                    
                    foreach ($technicians as $tech) {
                        if (isset($tech['recommendedTrainings']) && is_array($tech['recommendedTrainings'])) {
                            foreach ($tech['recommendedTrainings'] as $training) {
                                if (isset($training['brand']) && $training['brand'] === $brand) {
                                    $stats[$brand]['recommendedTrainings']++;
                                    
                                    if (isset($training['status']) && $training['status'] === 'validated') {
                                        $stats[$brand]['validatedTrainings']++;
                                    }
                                }
                            }
                        }
                    }
                }
                
            } catch (Exception $e) {
                error_log("Erreur lors du calcul des statistiques par marque: " . $e->getMessage());
            }
        }
        
        return $stats;
    }
    
    /**
     * R√©cup√®re les scores par marque pour les graphiques
     *
     * @param array $filters Filtres actuels √† appliquer
     * @return array Scores par marque
     */
    public function getBrandScores($filters = []) {
        $scores = [];
        
        if ($this->academy) {
            try {
                // R√©cup√©rer les marques disponibles
                $brands = $this->getBrands($filters);
                
                // Pour chaque marque, calculer un score moyen bas√© sur les √©valuations r√©elles
                foreach ($brands as $brand) {
                    // Construire la requ√™te pour trouver les techniciens de cette marque
                    $query = array_merge(
                        $this->getTechOrTestManagerClause(),   // Technicien ou Manager(test)
                        [
                            'active'            => true,
                            '$or'               => [
                                ['brandJunior' => $brand],
                                ['brandSenior' => $brand],
                                ['brandExpert' => $brand],
                            ],
                            'evaluationResults' => ['$exists' => true, '$ne' => []],
                        ],
                    );
                    
                    // Ajouter les filtres suppl√©mentaires
                    if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                        $query['subsidiary'] = $filters['subsidiary'];
                    }
                    if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                        $query['agency'] = $filters['agency'];
                    }
                    if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                        $query['manager'] = $filters['managerId'];
                    }
                    
                    // R√©cup√©rer les scores d'√©valuation pour cette marque
                    $technicians = $this->academy->users->find($query, [
                        'projection' => ['evaluationResults' => 1]
                    ])->toArray();
                    
                    // Calculer le score moyen
                    $totalScore = 0;
                    $count = 0;
                    
                    foreach ($technicians as $tech) {
                        if (isset($tech['evaluationResults']) && is_array($tech['evaluationResults'])) {
                            foreach ($tech['evaluationResults'] as $eval) {
                                if (isset($eval['brand']) && $eval['brand'] === $brand && isset($eval['score'])) {
                                    $totalScore += $eval['score'];
                                    $count++;
                                }
                            }
                        }
                    }
                    
                    $averageScore = ($count > 0) ? round($totalScore / $count) : 0;
                    
                    // D√©terminer la couleur en fonction du score
                    $fillColor = '#dc3545'; // Rouge par d√©faut (score faible)
                    if ($averageScore >= 80) {
                        $fillColor = '#198754'; // Vert (score √©lev√©)
                    } elseif ($averageScore >= 60) {
                        $fillColor = '#ffc107'; // Jaune (score moyen)
                    }
                    
                    // Cr√©er une donn√©e format√©e pour Chart.js
                    $scores[] = [
                        'x' => $brand,
                        'y' => $averageScore,
                        'fillColor' => $fillColor
                    ];
                }
                
                // Trier par score d√©croissant
                usort($scores, function($a, $b) {
                    return $b['y'] - $a['y'];
                });
                
            } catch (Exception $e) {
                error_log("Erreur lors du calcul des scores par marque: " . $e->getMessage());
            }
        }
        
        return $scores;
    }
    
    /**
     * R√©cup√®re les statistiques des formations
     *
     * @param array $filters Filtres actuels √† appliquer
     * @return array Statistiques des formations
     */
    public function getTrainingStats($filters = []) {
        $stats = [
            'totalTrainings' => 0,
            'recommendedTrainings' => 0,
            'validatedTrainings' => 0,
            'trainingDays' => 0,
            'brandTrainings' => []
        ];
        
        if ($this->academy) {
            try {
                // Construire la requ√™te de base pour les techniciens
                $query = array_merge(
                    $this->getTechOrTestManagerClause(),   // profil Technicien + Manager(test)
                    [
                        'active'               => true,
                        'recommendedTrainings' => ['$exists' => true, '$ne' => []],
                    ]
                );

                
                // Ajouter les filtres suppl√©mentaires
                if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                    $query['subsidiary'] = $filters['subsidiary'];
                }
                if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                    $query['agency'] = $filters['agency'];
                }
                if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                    $query['manager'] = $filters['managerId'];
                }
                if (isset($filters['level']) && $filters['level'] !== 'all') {
                    if ($filters['level'] === 'Junior') {
                        $query['level'] = ['$in' => ['Junior', 'Senior', 'Expert']];
                    } else if ($filters['level'] === 'Senior') {
                        $query['level'] = ['$in' => ['Senior', 'Expert']];
                    } else if ($filters['level'] === 'Expert') {
                        $query['level'] = 'Expert';
                    }
                }
                
                // Initialiser les statistiques par marque
                $brands = $this->getBrands($filters);
                foreach ($brands as $brand) {
                    $stats['brandTrainings'][$brand] = [
                        'recommended' => 0,
                        'validated' => 0
                    ];
                }
                
                // R√©cup√©rer les techniciens avec leurs formations recommand√©es
                $technicians = $this->academy->users->find($query, [
                    'projection' => ['recommendedTrainings' => 1]
                ])->toArray();
                
                // Calculer les statistiques de formation
                $totalDays = 0;
                
                foreach ($technicians as $tech) {
                    if (isset($tech['recommendedTrainings']) && is_array($tech['recommendedTrainings'])) {
                        foreach ($tech['recommendedTrainings'] as $training) {
                            // Incr√©menter le compteur total de formations recommand√©es
                            $stats['recommendedTrainings']++;
                            
                            // Si la formation a une marque associ√©e, mettre √† jour les stats par marque
                            if (isset($training['brand']) && isset($stats['brandTrainings'][$training['brand']])) {
                                $stats['brandTrainings'][$training['brand']]['recommended']++;
                                
                                // Si la formation est valid√©e, mettre √† jour les compteurs
                                if (isset($training['status']) && $training['status'] === 'validated') {
                                    $stats['validatedTrainings']++;
                                    $stats['brandTrainings'][$training['brand']]['validated']++;
                                }
                            } else {
                                // Si la formation est valid√©e mais sans marque sp√©cifique
                                if (isset($training['status']) && $training['status'] === 'validated') {
                                    $stats['validatedTrainings']++;
                                }
                            }
                            
                            // Ajouter les jours de formation au total
                            if (isset($training['duration'])) {
                                $totalDays += $training['duration'];
                            } else {
                                // Si la dur√©e n'est pas sp√©cifi√©e, estimer √† 1 jour
                                $totalDays += 1;
                            }
                        }
                    }
                }
                
                $stats['totalTrainings'] = $stats['recommendedTrainings'];
                $stats['trainingDays'] = $totalDays;
                
            } catch (Exception $e) {
                error_log("Erreur lors du calcul des statistiques de formation: " . $e->getMessage());
            }
        }
        
        return $stats;
    }
    
    /**
     * R√©cup√®re un r√©sum√© des techniciens par filiale
     *
     * @param array $filters Filtres actuels √† appliquer
     * @return array R√©sum√© par filiale
     */
    public function getTechnicianSummary($filters = []) {
        $summary = [];
        
        if ($this->academy) {
            try {
                // R√©cup√©rer les filiales
                $subsidiaries = $this->getSubsidiaries();
                
                // Pour chaque filiale, calculer les statistiques
                foreach ($subsidiaries as $subsidiary) {
                    // Cr√©er des filtres sp√©cifiques √† cette filiale
                    $subsidiaryFilters = array_merge($filters, ['subsidiary' => $subsidiary]);
                    
                    // R√©cup√©rer les statistiques de niveau pour cette filiale
                    $levelStats = $this->getLevelStats($subsidiaryFilters);
                    
                    // Calculer le total
                    $totalTechnicians = $levelStats['juniorCount'] + $levelStats['seniorCount'] + $levelStats['expertCount'];
                    
                    // Ne pas inclure les filiales sans techniciens
                    if ($totalTechnicians > 0) {
                        $summary[$subsidiary] = [
                            'totalTechnicians' => $totalTechnicians,
                            'juniorCount' => $levelStats['juniorCount'],
                            'seniorCount' => $levelStats['seniorCount'],
                            'expertCount' => $levelStats['expertCount']
                        ];
                    }
                }
                
            } catch (Exception $e) {
                error_log("Erreur lors du calcul du r√©sum√© des techniciens: " . $e->getMessage());
            }
        }
        
        return $summary;
    }

    /**
     * Calcule le nombre de formations propos√©es et valid√©es par marque
     * en appliquant les filtres sp√©cifi√©s.
     *
     * @param array $filters Filtres du dashboard
     * @return array [ 'trainingsCounts' => [], 'validationsCounts' => [] ]
     */
    public function getTrainingValidationStats($filters = []) {
        $result = [
            'trainingsCounts'   => [],
            'validationsCounts' => []
        ];

        if (!$this->academy) {
            return $result;
        }

        try {
            $techQuery = array_merge(
                $this->getTechOrTestManagerClause(),
                ['active' => true]
            );

            if (isset($filters['subsidiary']) && $filters['subsidiary'] !== 'all') {
                $techQuery['subsidiary'] = $filters['subsidiary'];
            }
            if (isset($filters['agency']) && $filters['agency'] !== 'all') {
                $techQuery['agency'] = $filters['agency'];
            }
            if (isset($filters['managerId']) && $filters['managerId'] !== 'all') {
                $techQuery['manager'] = $filters['managerId'];
            }
            if (isset($filters['technicianId']) && $filters['technicianId'] !== 'all') {
                $techQuery['_id'] = new ObjectId($filters['technicianId']);
            }
            if (isset($filters['level']) && $filters['level'] !== 'all') {
                $techQuery['level'] = $filters['level'];
            }

            $techCursor = $this->academy->users->find($techQuery, ['projection' => ['_id' => 1]]);
            $techIds   = [];
            foreach ($techCursor as $doc) {
                $techIds[] = $doc['_id'];
            }

            if (empty($techIds)) {
                return $result;
            }

            $trainMatch = [
                'active' => true,
                'users'  => ['$in' => $techIds]
            ];
            if (isset($filters['brand']) && $filters['brand'] !== 'all') {
                $trainMatch['brand'] = $filters['brand'];
            }
            if (isset($filters['level']) && $filters['level'] !== 'all') {
                $trainMatch['level'] = $filters['level'];
            }

            $pipelineTrain = [
                ['$match' => $trainMatch],
                ['$group' => [ '_id' => '$brand', 'count' => ['$sum' => 1]]]
            ];

            foreach ($this->academy->trainings->aggregate($pipelineTrain) as $doc) {
                $brand = (string)$doc->_id;
                $result['trainingsCounts'][$brand] = (int)$doc->count;
            }

            $validPipeline = [
                ['$match' => ['status' => 'Valid√©', 'user' => ['$in' => $techIds]]],
                ['$lookup' => [
                    'from'         => 'trainings',
                    'localField'   => 'training',
                    'foreignField' => '_id',
                    'as'           => 'training'
                ]],
                ['$unwind' => '$training']
            ];

            if (isset($filters['brand']) && $filters['brand'] !== 'all') {
                $validPipeline[] = ['$match' => ['training.brand' => $filters['brand']]];
            }
            if (isset($filters['level']) && $filters['level'] !== 'all') {
                $validPipeline[] = ['$match' => ['training.level' => $filters['level']]];
            }

            $validPipeline[] = ['$group' => [ '_id' => '$training.brand', 'count' => ['$sum' => 1]]];

            foreach ($this->academy->validations->aggregate($validPipeline) as $doc) {
                $brand = (string)$doc->_id;
                $result['validationsCounts'][$brand] = (int)$doc->count;
            }

        } catch (Exception $e) {
            error_log('Erreur getTrainingValidationStats: ' . $e->getMessage());
        }

        return $result;
    }
}
